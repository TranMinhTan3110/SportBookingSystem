@model SportBookingSystem.Models.ViewModels.ReportDataViewModel
@{
    ViewData["Title"] = "Báo cáo - Thống kê";
    Layout = "~/Views/Shared/LayoutAdmin.cshtml";
}
@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <link rel="stylesheet" href="~/asset/css/reportAD.css" />
}
<body>
    <div class="container-fluid px-4 report-page">
        <!-- Header -->
        <div class="header-section">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-2"></i>Báo Cáo - Phân Tích
                </h1>
                <p class="page-subtitle">Tổng quan doanh thu và xu hướng kinh doanh</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="glass-card stat-card card-total">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-label">Tổng Doanh Thu</div>
                <div class="stat-value" id="totalRevenue">@Model.TotalRevenue.ToString("N0")₫</div>
                <div class="stat-change @(Model.GrowthRate >= 0 ? "positive" : "negative")">
                    <i class="fas fa-arrow-@(Model.GrowthRate >= 0 ? "up" : "down")"></i>
                    <span>@(Model.GrowthRate >= 0 ? "+" : "")@Model.GrowthRate.ToString("F1")% so với kỳ trước</span>
                </div>
            </div>

            <div class="glass-card stat-card card-booking">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-label">Đặt Sân</div>
                <div class="stat-value" id="bookingRevenue">@Model.BookingRevenue.ToString("N0")₫</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Từ đặt sân</span>
                </div>
            </div>

            <div class="glass-card stat-card card-service">
                <div class="stat-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-label">Dịch Vụ</div>
                <div class="stat-value" id="serviceRevenue">@Model.ServiceRevenue.ToString("N0")₫</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Từ dịch vụ</span>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="glass-card filter-section">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-2">
                        <i class="fas fa-calendar me-1"></i>Từ Ngày
                    </label>
                    <input type="date" class="form-control" id="fromDate" value="@ViewBag.FromDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-2">
                        <i class="fas fa-calendar me-1"></i>Đến Ngày
                    </label>
                    <input type="date" class="form-control" id="toDate" value="@ViewBag.ToDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-2">
                        <i class="fas fa-filter me-1"></i>Kỳ Báo Cáo
                    </label>
                    <select class="form-select" id="reportPeriod" onchange="handlePeriodChange()">
                        <option value="custom" selected>Tùy chỉnh</option>
                        <option value="today">Hôm nay</option>
                        <option value="yesterday">Hôm qua</option>
                        <option value="thisweek">Tuần này</option>
                        <option value="lastweek">Tuần trước</option>
                        <option value="thismonth">Tháng này</option>
                        <option value="lastmonth">Tháng trước</option>
                        <option value="quarter">Quý này</option>
                        <option value="year">Năm nay</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-apply w-100" onclick="applyFilter()">
                        <i class="fas fa-sync-alt me-2"></i>Áp Dụng
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-lg-8">
                <div class="glass-card chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-area text-primary"></i>
                        Doanh Thu Theo Thời Gian
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="glass-card chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie text-success"></i>
                        Doanh Thu Theo Nguồn
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performing Sports -->
        @if (Model.TopSports != null && Model.TopSports.Any())
        {
            <div class="glass-card summary-section">
                <div class="section-title">
                    <i class="fas fa-trophy text-warning"></i>
                    Môn Thể Thao Hoạt Động Tốt Nhất
                </div>
                <div class="sports-grid" id="topSportsContainer">
                    @foreach (var sport in Model.TopSports)
                    {
                        <div class="glass-card sport-card @sport.ColorClass">
                            <div class="sport-header">
                                <div class="sport-icon">
                                    <i class="@sport.IconClass"></i>
                                </div>
                                <div class="sport-name">@sport.SportName</div>
                            </div>
                            <div class="sport-stats">
                                <div class="sport-stat-row">
                                    <span class="sport-stat-label">Doanh thu</span>
                                    <span class="sport-stat-value">@sport.Revenue.ToString("N0")₫</span>
                                </div>
                                <div class="sport-stat-row">
                                    <span class="sport-stat-label">Số lượt đặt</span>
                                    <span class="sport-stat-value">@sport.BookingCount</span>
                                </div>
                                <div class="sport-stat-row">
                                    <span class="sport-stat-label">Tăng trưởng</span>
                                    <span class="growth-badge @(sport.Growth >= 0 ? "growth-positive" : "growth-negative")">
                                        <i class="fas fa-arrow-@(sport.Growth >= 0 ? "up" : "down")"></i>@sport.Growth.ToString("F1")%
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Monthly Summary Table with Filter -->
        <div class="glass-card summary-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="section-title mb-0">
                    <i class="fas fa-calendar-alt text-info"></i>
                    Tổng Kết Theo Tháng
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleMonthFilter()">
                    <i class="fas fa-filter me-1"></i>Lọc theo tháng
                </button>
            </div>

            <!-- Month Filter -->
            <div id="monthFilterSection" style="display: none;" class="mb-3 p-3 bg-dark rounded">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-2">Từ tháng</label>
                        <select class="form-select form-select-sm" id="fromMonth">
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i" selected="@(i == DateTime.Now.AddMonths(-2).Month)">Tháng @i</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-2">Năm</label>
                        <select class="form-select form-select-sm" id="fromYear">
                            @for (int year = DateTime.Now.Year; year >= 2020; year--)
                            {
                                <option value="@year" selected="@(year == DateTime.Now.AddMonths(-2).Year)">@year</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-2">Đến tháng</label>
                        <select class="form-select form-select-sm" id="toMonth">
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i" selected="@(i == DateTime.Now.Month)">Tháng @i</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-2">Năm</label>
                        <select class="form-select form-select-sm" id="toYear">
                            @for (int year = DateTime.Now.Year; year >= 2020; year--)
                            {
                                <option value="@year" selected="@(year == DateTime.Now.Year)">@year</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-sm btn-primary w-100" onclick="applyMonthFilter()">
                            <i class="fas fa-sync-alt me-1"></i>Áp dụng
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tháng</th>
                            <th>Tổng Doanh Thu</th>
                            <th>Số Giao Dịch</th>
                            <th>Doanh Thu TB/GD</th>
                            <th>Tăng Trưởng</th>
                        </tr>
                    </thead>
                    <tbody id="monthlySummaryBody">
                        @if (Model.MonthlySummaries != null && Model.MonthlySummaries.Any())
                        {
                            @foreach (var summary in Model.MonthlySummaries)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-semibold">@summary.MonthLabel</div>
                                        <div class="text-muted small">@summary.DateRange</div>
                                    </td>
                                    <td class="amount-cell">@summary.TotalRevenue.ToString("N0")₫</td>
                                    <td>@summary.TransactionCount</td>
                                    <td>@summary.AveragePerTransaction.ToString("N0")₫</td>
                                    <td>
                                        <span class="growth-badge @(summary.GrowthRate >= 0 ? "growth-positive" : "growth-negative")">
                                            <i class="fas fa-arrow-@(summary.GrowthRate >= 0 ? "up" : "down")"></i>@summary.GrowthRate.ToString("F1")%
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
<script src="~/asset/js/reportAD.js"></script>
<script>
    // Khởi tạo biểu đồ khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        initializeMonthFilters();
    });
</script>