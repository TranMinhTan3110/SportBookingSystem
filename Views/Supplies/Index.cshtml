@{
    ViewData["Title"] = "Đồ dùng thể thao";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    @* <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"> *@
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="~/css/Supplies.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
}
<section class="banner">
    <div class="breadcrumb">
        <a href="/">🏠 Trang chủ</a>
        <span class="separator">›</span>
        <a href="/dich-vu">Dịch vụ</a>
        <span class="separator">›</span>
        <span class="current">Dụng cụ thể thao</span>
    </div>
    <div class="banner-content">
        <h1>Chào mừng đến với đồ dùng thể thao</h1>
        <p>Nơi cung cấp đầy đủ dụng cụ thể thao cho mọi nhu cầu của bạn!</p>
    </div>
</section>
<section class="main-content">
    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Bộ Lọc - 3 cột -->
            <div class="col-lg-3 col-md-4 col-12">
                <div class="filter-sidebar">
                    <h4 class="filter-title">🔍 Bộ Lọc</h4>

                    <!-- Search Bar -->
                    <div class="filter-group">
                        <h5>Tìm kiếm</h5>
                        <input type="text" id="userSearchInput" class="form-control" placeholder="Tên sản phẩm, thương hiệu...">
                    </div>

                    <!-- Danh mục (Dynamic) -->
                    <div class="filter-group">
                        <h5>Danh mục</h5>
                        <div id="categoryFilters">
                           <p class="text-muted">Đang tải...</p>
                        </div>
                    </div>

                    <!-- Khoảng giá -->
                    <div class="filter-group">
                        <h5>Khoảng giá</h5>
                        <div class="price-range">
                            <input type="number" id="minPrice" placeholder="Từ" min="0">
                            <span>-</span>
                            <input type="number" id="maxPrice" placeholder="Đến" min="0">
                        </div>
                    </div>

                    <!-- Thương hiệu (Dynamic) -->
                    <div class="filter-group">
                        <h5>Thương hiệu</h5>
                        <div id="brandFilters">
                            <p class="text-muted">Đang tải...</p>
                        </div>
                    </div>

                    <button class="btn-apply-filter" onclick="applyFilters()">Áp dụng</button>
                    <button class="btn-reset-filter" onclick="resetFilters()">Xóa bộ lọc</button>
                </div>
            </div>

            <!-- Sản phẩm - 9 cột -->
            <div class="col-lg-9 col-md-8 col-12">
                <div class="products-section">
                    <!-- Header -->
                    <div class="products-header">
                        <div class="products-count" id="productsCount">
                            Đang tải sản phẩm...
                        </div>
                        <div class="sort-dropdown">
                            <select id="sortBy" onchange="applyFilters()">
                                <option value="newest">Sắp xếp: Mới nhất</option>
                                <option value="price_asc">Giá: Thấp đến cao</option>
                                <option value="price_desc">Giá: Cao đến thấp</option>
                                <option value="name_asc">Tên: A-Z</option>
                            </select>
                        </div>
                    </div>

                    <!-- Product Grid (Dynamic) -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Dynamic products will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Purchase Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-cart-shopping me-2"></i>Thanh toán sản phẩm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                    <img id="modalProductImage" src="" alt="" class="rounded-3 me-3" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid #fff;">
                    <div>
                        <h6 id="modalProductName" class="fw-bold mb-1" style="font-size: 1.1rem;"></h6>
                        <p id="modalProductPrice" class="text-primary fw-bold mb-0"></p>
                    </div>
                </div>
                
                <div class="bg-light p-3 rounded-3 mb-4">
                    <label class="form-label fw-bold mb-2">Số lượng mua</label>
                    <div class="input-group">
                        <button class="btn btn-outline-primary px-3" onclick="updateQuantity(-1)">-</button>
                        <input type="number" id="purchaseQuantity" class="form-control text-center fw-bold border-primary" value="1" min="1" readonly>
                        <button class="btn btn-outline-primary px-3" onclick="updateQuantity(1)">+</button>
                    </div>
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <span class="text-muted">Tổng cộng:</span>
                        <h4 id="modalTotalPrice" class="text-danger fw-bold mb-0">0₫</h4>
                    </div>
                </div>

                <div class="alert alert-info border-0 mb-0" style="background-color: #e3f2fd; color: #0d47a1;">
                    <i class="fa-solid fa-circle-info me-2"></i> Số dư sẽ được trừ trực tiếp vào ví sau khi nhấn thanh toán.
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light px-4 py-2 fw-semibold" data-bs-dismiss="modal" style="border-radius: 10px;">Hủy bỏ</button>
                <button type="button" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm" onclick="confirmPayment()" style="border-radius: 10px;">Xác nhận thanh toán</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Success Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="fa-solid fa-check fa-2xl"></i>
                    </div>
                    <h3 class="fw-bold text-success">Thanh toán thành công!</h3>
                    <p class="text-muted">Vui lòng lưu lại mã QR dưới đây và đưa cho nhân viên tại sân để nhận đồ.</p>
                </div>
                
                <div class="qr-container p-3 bg-white border rounded-4 mb-4 shadow-sm">
                    <img id="purchaseQrCode" src="" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                </div>

                <button type="button" class="btn btn-primary w-100 py-3 fw-bold" onclick="location.reload()" style="border-radius: 15px;">Đã hiểu, Quay lại</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterData();
            applyFilters();
        });

        function loadFilterData() {
            fetch('/Supplies/GetFilterData')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                    return response.json();
                })
                .then(res => {
                    if (res.success) {
                        const catContainer = document.getElementById('categoryFilters');
                        catContainer.innerHTML = res.categories.map(c => `
                            <div class="filter-option">
                                <input type="checkbox" class="cat-check" id="cat-${c.categoryId}" value="${c.categoryName}">
                                <label for="cat-${c.categoryId}">${c.categoryName}</label>
                            </div>
                        `).join('');

                        const brandContainer = document.getElementById('brandFilters');
                        brandContainer.innerHTML = res.brands.map((b, i) => `
                            <div class="filter-option">
                                <input type="checkbox" class="brand-check" id="brand-${i}" value="${b}">
                                <label for="brand-${i}">${b}</label>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error fetching filter data:', error);
                    document.getElementById('categoryFilters').innerHTML = '<p class="text-danger small">Lỗi tải dữ liệu lọc</p>';
                });
        }

        function applyFilters() {
            const search = document.getElementById('userSearchInput').value;
            const sortBy = document.getElementById('sortBy').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;

            const categories = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value).join(',');
            const brands = Array.from(document.querySelectorAll('.brand-check:checked')).map(cb => cb.value).join(',');

            const params = new URLSearchParams({
                search,
                categories,
                brands,
                minPrice,
                maxPrice,
                sortBy
            });

            const grid = document.getElementById('productsGrid');
            const countLabel = document.getElementById('productsCount');
            grid.innerHTML = '<div class="w-100 text-center py-5"><div class="spinner-border text-primary"></div></div>';

            fetch(`/Supplies/GetFilteredProducts?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                    return response.json();
                })
                .then(res => {
                    if (res.success) {
                        renderProducts(res.data);
                        countLabel.innerHTML = `Hiển thị <strong>${res.data.length}</strong> sản phẩm`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    grid.innerHTML = '<div class="w-100 text-center py-5"><p class="text-danger">Có lỗi xảy ra khi tải sản phẩm. Vui lòng thử lại sau.</p></div>';
                });
        }

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            if (products.length === 0) {
                grid.innerHTML = '<div class="w-100 text-center py-5"><p class="text-muted">Không tìm thấy sản phẩm nào phù hợp.</p></div>';
                return;
            }

            grid.innerHTML = products.map(p => `
                <div class="product-card shadow-sm border-0" style="border-radius: 15px; overflow: hidden; transition: transform 0.3s;">
                    <div class="product-image position-relative">
                        <img src="${p.imageUrl || '/img/placeholder.jpg'}" alt="${p.productName}" style="height: 200px; width: 100%; object-fit: cover;">
                        <span class="badge bg-primary position-absolute top-0 end-0 m-3 shadow-sm">${p.category ? p.category.categoryName : 'Khác'}</span>
                    </div>
                    <div class="product-info p-3">
                        <div class="product-name fw-bold mb-1" style="font-size: 1.1rem; height: 2.6rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${p.productName}</div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="product-price text-primary fw-bold fs-5">${p.price.toLocaleString('vi-VN')}₫</div>
                            <div class="text-muted small"><i class="fa-solid fa-box-open me-1"></i>Còn: ${p.stockQuantity}</div>
                        </div>
                        <div class="d-grid gap-2">
                             <button class="btn btn-primary py-2 fw-semibold" onclick="openPurchaseModal(${p.productId}, '${p.productName.replace(/'/g, "\\'")}', ${p.price}, '${p.imageUrl || '/img/placeholder.jpg'}')" style="border-radius: 10px;">
                                <i class="fa-solid fa-bag-shopping me-2"></i>Mua ngay
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        let selectedProduct = null;
        let purchaseModal = null;
        let qrModal = null;

        function openPurchaseModal(id, name, price, image) {
            selectedProduct = { id, name, price };
            document.getElementById('modalProductImage').src = image;
            document.getElementById('modalProductName').innerText = name;
            document.getElementById('modalProductPrice').innerText = price.toLocaleString('vi-VN') + '₫';
            document.getElementById('purchaseQuantity').value = 1;
            calculateModalTotal();

            if (!purchaseModal) {
                purchaseModal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            }
            purchaseModal.show();
        }

        function updateQuantity(amount) {
            const input = document.getElementById('purchaseQuantity');
            let val = parseInt(input.value) + amount;
            if (val < 1) val = 1;
            input.value = val;
            calculateModalTotal();
        }

        function calculateModalTotal() {
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const total = selectedProduct.price * quantity;
            document.getElementById('modalTotalPrice').innerText = total.toLocaleString('vi-VN') + '₫';
        }

        function confirmPayment() {
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            
            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            fetch('/Supplies/Purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `productId=${selectedProduct.id}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(res => {
                Swal.close();
                if (res.success) {
                    purchaseModal.hide();
                    document.getElementById('purchaseQrCode').src = 'data:image/png;base64,' + res.qrCode;
                    if (!qrModal) {
                        qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
                    }
                    qrModal.show();
                } else {
                    Swal.fire({ icon: 'error', title: 'Thất bại', text: res.message });
                }
            })
            .catch(error => {
                Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Có lỗi xảy ra khi kết nối máy chủ.' });
            });
        }

        function resetFilters() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('sortBy').value = 'newest';
            document.querySelectorAll('.cat-check, .brand-check').forEach(cb => cb.checked = false);
            applyFilters();
        }
    </script>
}
