@{
    ViewData["Title"] = "Đồ dùng thể thao";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    @* <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"> *@
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="~/css/Supplies.css" rel="stylesheet" />
}
<section class="banner">
    <div class="breadcrumb">
        <a href="/">🏠 Trang chủ</a>
        <span class="separator">›</span>
        <a href="/dich-vu">Dịch vụ</a>
        <span class="separator">›</span>
        <span class="current">Dụng cụ thể thao</span>
    </div>
    <div class="banner-content">
        <h1>Chào mừng đến với đồ dùng thể thao</h1>
        <p>Nơi cung cấp đầy đủ dụng cụ thể thao cho mọi nhu cầu của bạn!</p>
    </div>
</section>
<section class="main-content">
    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Bộ Lọc - 3 cột -->
            <div class="col-lg-3 col-md-4 col-12">
                <div class="filter-sidebar">
                    <h4 class="filter-title">🔍 Bộ Lọc</h4>

                    <!-- Search Bar -->
                    <div class="filter-group">
                        <h5>Tìm kiếm</h5>
                        <input type="text" id="userSearchInput" class="form-control" placeholder="Tên sản phẩm, thương hiệu...">
                    </div>

                    <!-- Danh mục (Dynamic) -->
                    <div class="filter-group">
                        <h5>Danh mục</h5>
                        <div id="categoryFilters">
                           <p class="text-muted">Đang tải...</p>
                        </div>
                    </div>

                    <!-- Khoảng giá -->
                    <div class="filter-group">
                        <h5>Khoảng giá</h5>
                        <div class="price-range">
                            <input type="number" id="minPrice" placeholder="Từ" min="0">
                            <span>-</span>
                            <input type="number" id="maxPrice" placeholder="Đến" min="0">
                        </div>
                    </div>

                    <!-- Thương hiệu (Dynamic) -->
                    <div class="filter-group">
                        <h5>Thương hiệu</h5>
                        <div id="brandFilters">
                            <p class="text-muted">Đang tải...</p>
                        </div>
                    </div>

                    <button class="btn-apply-filter" onclick="applyFilters()">Áp dụng</button>
                    <button class="btn-reset-filter" onclick="resetFilters()">Xóa bộ lọc</button>
                </div>
            </div>

            <!-- Sản phẩm - 9 cột -->
            <div class="col-lg-9 col-md-8 col-12">
                <div class="products-section">
                    <!-- Header -->
                    <div class="products-header">
                        <div class="products-count" id="productsCount">
                            Đang tải sản phẩm...
                        </div>
                        <div class="sort-dropdown">
                            <select id="sortBy" onchange="applyFilters()">
                                <option value="newest">Sắp xếp: Mới nhất</option>
                                <option value="price_asc">Giá: Thấp đến cao</option>
                                <option value="price_desc">Giá: Cao đến thấp</option>
                                <option value="name_asc">Tên: A-Z</option>
                            </select>
                        </div>
                    </div>

                    <!-- Product Grid (Dynamic) -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Dynamic products will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterData();
            applyFilters();
        });

        function loadFilterData() {
            fetch('/Supplies/GetFilterData')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                    return response.json();
                })
                .then(res => {
                    if (res.success) {
                        const catContainer = document.getElementById('categoryFilters');
                        catContainer.innerHTML = res.categories.map(c => `
                            <div class="filter-option">
                                <input type="checkbox" class="cat-check" id="cat-${c.categoryId}" value="${c.categoryName}">
                                <label for="cat-${c.categoryId}">${c.categoryName}</label>
                            </div>
                        `).join('');

                        const brandContainer = document.getElementById('brandFilters');
                        brandContainer.innerHTML = res.brands.map((b, i) => `
                            <div class="filter-option">
                                <input type="checkbox" class="brand-check" id="brand-${i}" value="${b}">
                                <label for="brand-${i}">${b}</label>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error fetching filter data:', error);
                    document.getElementById('categoryFilters').innerHTML = '<p class="text-danger small">Lỗi tải dữ liệu lọc</p>';
                });
        }

        function applyFilters() {
            const search = document.getElementById('userSearchInput').value;
            const sortBy = document.getElementById('sortBy').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;

            const categories = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value).join(',');
            const brands = Array.from(document.querySelectorAll('.brand-check:checked')).map(cb => cb.value).join(',');

            const params = new URLSearchParams({
                search,
                categories,
                brands,
                minPrice,
                maxPrice,
                sortBy
            });

            const grid = document.getElementById('productsGrid');
            const countLabel = document.getElementById('productsCount');
            grid.innerHTML = '<div class="w-100 text-center py-5"><div class="spinner-border text-primary"></div></div>';

            fetch(`/Supplies/GetFilteredProducts?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                    return response.json();
                })
                .then(res => {
                    if (res.success) {
                        renderProducts(res.data);
                        countLabel.innerHTML = `Hiển thị <strong>${res.data.length}</strong> sản phẩm`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    grid.innerHTML = '<div class="w-100 text-center py-5"><p class="text-danger">Có lỗi xảy ra khi tải sản phẩm. Vui lòng thử lại sau.</p></div>';
                });
        }

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            if (products.length === 0) {
                grid.innerHTML = '<div class="w-100 text-center py-5"><p class="text-muted">Không tìm thấy sản phẩm nào phù hợp.</p></div>';
                return;
            }

            grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <div class="product-image">
                        <img src="${p.imageUrl || '/img/placeholder.jpg'}" alt="${p.productName}">
                    </div>
                    <div class="product-info">
                        <div class="product-typeName">${p.category ? p.category.categoryName : 'Khác'}</div>
                        <div class="product-name">${p.productName}</div>
                        <div class="product-price">${p.price.toLocaleString('vi-VN')}₫</div>
                        <div class="btn-contain d-flex justify-content-end align-items-center">
                            <button class="btn border-0 bg-transparent" title="Mua ngay">
                                <i class="fa-solid fa-wallet fa-xl" style="color: #63E6BE;"></i>
                            </button>
                            <button class="btn border-0 bg-transparent" title="Thêm vào giỏ">
                                <i class="fa-solid fa-cart-arrow-down fa-xl" style="color: #0e86e1;"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function resetFilters() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('sortBy').value = 'newest';
            document.querySelectorAll('.cat-check, .brand-check').forEach(cb => cb.checked = false);
            applyFilters();
        }
    </script>
}
