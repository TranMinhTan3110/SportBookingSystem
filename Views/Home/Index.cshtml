@using SportBookingSystem.Models.ViewModels
@model HomeViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <link rel="stylesheet" href="~/css/Home.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
}

<!-- Hero Section -->
<section class="hero">
    <div class="hero-background">
        <img src="~/asset/img/hero-section-pic.png" class="hero-pic">
    </div>
    <div class="hero-content">
        <h1>Đặt Sân Bóng<br>Dễ Dàng & Nhanh Chóng</h1>
        <p>Hệ thống đặt sân thể thao trực tuyến hiện đại với thanh toán ví điện tử tiện lợi</p>
        <div class="hero-actions">
            <a href="#fields" class="btn btn-primary" id="btnBookNow"><i class="bi bi-calendar-check-fill"></i> Đặt sân ngay</a>
            <a href="#features" class="btn btn-secondary"><i class="bi bi-info-circle-fill"></i> Tìm hiểu thêm</a>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container">
    <!-- Wallet & Quick Actions -->
    <div class="wallet-section fade-in-up">
        <div class="wallet-card">
            <div class="wallet-header">
                <div>
                    <div class="wallet-title">Ví Điện Tử</div>
                </div>
                <div class="wallet-icon"><i class="bi bi-wallet-fill"></i></div>
            </div>

            <div class="wallet-balance-display">
                <div class="balance-label">Số dư khả dụng</div>
                <div class="balance-amount">@Model.User.WalletBalance.ToString("N0")₫</div>
            </div>

            <div class="wallet-actions">
                <button class="wallet-btn" data-bs-toggle="modal" data-bs-target="#topupModal">
                    <i class="bi bi-plus-circle-fill"></i> Nạp tiền
                </button>
                <button class="wallet-btn " data-bs-toggle="modal" data-bs-target="#transferMoneyModal">
                    <i class="bi bi-cash-coin"></i> Chuyển khoản
                </button>
            </div>
        </div>


      

        <div class="quick-actions">
            <h3 class="quick-actions-title">Thao tác nhanh</h3>
            <div class="action-list">
                <a href="@Url.Action("Index", "History")" class="action-item">
                    <div class="action-icon"><i class="bi bi-calendar-event-fill"></i></div>
                    <div class="action-text">
                        <div class="action-title">Lịch đặt sân của tôi</div>
                        <div class="action-desc">@Model.PendingBookingsCount lịch chờ xác nhận</div>
                    </div>
                    <span>→</span>
                </a>

                <a href="#" class="action-item">
                    <div class="action-icon"><i class="bi bi-gift-fill"></i></div>
                    <div class="action-text">
                        <div class="action-title">Điểm thưởng</div>
                        <div class="action-desc">@Model.User.RewardPoints.ToString("N0") điểm</div>
                    </div>
                    <span>→</span>
                </a>

                <a href="@Url.Action("Index", "UserProfile")" class="action-item">
                    <div class="action-icon"><i class="bi bi-gear-fill"></i></div>
                    <div class="action-text">
                        <div class="action-title">Cài đặt</div>
                        <div class="action-desc">Quản lý tài khoản</div>
                    </div>
                    <span>→</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Fields Section -->
    <section id="fields" class="fade-in-up delay-1">
        <div class="section-header">
            <div class="section-header-content">
                <h2 class="section-title"><i class="bi bi-trophy-fill"></i> Chọn Sân Yêu Thích</h2>
                <p class="section-subtitle">Đa dạng loại sân, giá cả hợp lý, đặt sân dễ dàng</p>
            </div>
            <a href="@Url.Action("Index", "Booking")" class="view-all-btn">
                Xem tất cả →
            </a>
        </div>
        <div class="fields-grid">
            @if (Model.FeaturedPitches != null && Model.FeaturedPitches.Any())
            {
                foreach (var pitch in Model.FeaturedPitches.Take(3))
                {
                    <div class="product-card shadow-sm border-0" style="border-radius: 15px; overflow: hidden; transition: transform 0.3s; background: white;">
                        <div class="product-image position-relative">
                            <img src="@(string.IsNullOrEmpty(pitch.ImageUrl) ? "/asset/img/SanNamNguoi.webp" : pitch.ImageUrl)" alt="@pitch.PitchName" style="height: 200px; width: 100%; object-fit: cover;">
                            <span class="badge bg-primary position-absolute top-0 end-0 m-2 shadow-sm fs-6 px-2 py-1">@pitch.Category?.CategoryName</span>
                        </div>
                        <div class="product-info p-3">
                            <div class="product-name fw-bold mb-1" style="font-size: 1.1rem; height: 2.6rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: #1f2937;">@pitch.PitchName</div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="product-price text-primary fw-bold fs-5">@pitch.PricePerHour.ToString("N0")₫/h</div>
                                <div class="text-muted small"><i class="bi bi-people-fill me-1"></i>@pitch.Capacity người</div>
                            </div>
                            <div class="d-grid">
                                <a href="@Url.Action("Index", "Booking")" class="btn btn-primary py-2 fw-semibold" style="border-radius: 10px;">
                                    <i class="bi bi-calendar-check-fill me-2"></i>Đặt sân ngay
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Đang cập nhật danh sách sân...</p>
            }
        </div>
    </section>


    <!-- ĐỒ ĂN & THỨC UỐNG NỔI BẬT -->
    <section id="food-drinks" class="products-section fade-in-up delay-2">
        <div class="section-header">
            <div class="section-header-content">
                <h2 class="section-title"><i class="bi bi-cup-hot-fill"></i> Đồ Ăn & Thức Uống Bán Chạy</h2>
                <p class="section-subtitle">Những món quà tuyệt vời tiếp thêm năng lượng sau trận đấu</p>
            </div>
            <a href="@Url.Action("Index", "Food")" class="view-all-btn">
                Xem tất cả →
            </a>
        </div>

        <div class="products-grid">
            @if (Model.FeaturedFoodItems != null && Model.FeaturedFoodItems.Any())
            {
                foreach (var p in Model.FeaturedFoodItems.Take(3))
                {
                    <div class="product-card shadow-sm border-0" style="border-radius: 15px; overflow: hidden; transition: transform 0.3s; background: white;">
                        <div class="product-image position-relative">
                            <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "/asset/img/bannerFood.jpg" : p.ImageUrl)" alt="@p.ProductName" style="height: 200px; width: 100%; object-fit: cover;">
                            <span class="badge bg-primary position-absolute top-0 end-0 m-2 shadow-sm fs-6 px-2 py-1">@p.Category?.CategoryName</span>
                        </div>
                        <div class="product-info p-3">
                            <div class="product-name fw-bold mb-1" style="font-size: 1.1rem; height: 2.6rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: #1f2937;">@p.ProductName</div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="product-price text-primary fw-bold fs-5">@p.Price.ToString("N0")₫</div>
                                <div class="text-muted small"><i class="fa-solid fa-box-open me-1"></i>Còn: @p.StockQuantity</div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button class="btn btn-primary py-2 fw-semibold flex-fill" onclick="openPurchaseModal(@p.ProductId, '@p.ProductName.Replace("'", "\\'")', @p.Price, '@(string.IsNullOrEmpty(p.ImageUrl) ? "/asset/img/default-product.jpg" : p.ImageUrl)', 'food')" style="border-radius: 10px;">
                                    <i class="fa-solid fa-bag-shopping me-2"></i>Mua ngay
                                </button>
                                <button class="btn btn-outline-primary py-2 fw-semibold flex-fill" id="btnAddToCart" onclick="addToCart(@p.ProductId, '@p.ProductName.Replace("'", "\\'")', @p.Price)" style="border-radius: 10px;">
                                    <i class="fa-solid fa-cart-plus me-2"></i>Thêm vào giỏ
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Đang cập nhật sản phẩm...</p>
            }
        </div>
    </section>

    <!-- ĐỒ DÙNG THỂ THAO NỔI BẬT -->
    <section id="products" class="products-section fade-in-up delay-3">
        <div class="section-header">
            <div class="section-header-content">
                <h2 class="section-title"><i class="bi bi-trophy-fill"></i> Đồ Dùng Thể Thao Phổ Biến</h2>
                <p class="section-subtitle">Trang bị chất lượng cho những vận động viên thực thụ</p>
            </div>
            <a href="@Url.Action("Index", "Supplies")" class="view-all-btn">
                Xem tất cả →
            </a>
        </div>

        <div class="products-grid">
            @if (Model.FeaturedSupplies != null && Model.FeaturedSupplies.Any())
            {
                foreach (var p in Model.FeaturedSupplies.Take(3))
                {
                    <div class="product-card shadow-sm border-0" style="border-radius: 15px; overflow: hidden; transition: transform 0.3s; background: white;">
                        <div class="product-image position-relative">
                            <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "/asset/img/bannerFood.jpg" : p.ImageUrl)" alt="@p.ProductName" style="height: 200px; width: 100%; object-fit: cover;">
                            <span class="badge bg-primary position-absolute top-0 end-0 m-2 shadow-sm fs-6 px-2 py-1">@p.Category?.CategoryName</span>
                        </div>
                        <div class="product-info p-3">
                            <div class="product-name fw-bold mb-1" style="font-size: 1.1rem; height: 2.6rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: #1f2937;">@p.ProductName</div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="product-price text-primary fw-bold fs-5">@p.Price.ToString("N0")₫</div>
                                <div class="text-muted small"><i class="fa-solid fa-box-open me-1"></i>Còn: @p.StockQuantity</div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button class="btn btn-primary py-2 fw-semibold flex-fill" onclick="openPurchaseModal(@p.ProductId, '@p.ProductName.Replace("'", "\\'")', @p.Price, '@(string.IsNullOrEmpty(p.ImageUrl) ? "/asset/img/default-product.jpg" : p.ImageUrl)', 'supply')" style="border-radius: 10px;">
                                    <i class="fa-solid fa-bag-shopping me-2"></i>Mua ngay
                                </button>
                                <button class="btn btn-outline-primary py-2 fw-semibold flex-fill" id="btnAddToCart" onclick="addToCart(@p.ProductId, '@p.ProductName.Replace("'", "\\'")', @p.Price)" style="border-radius: 10px;">
                                    <i class="fa-solid fa-cart-plus me-2"></i>Thêm vào giỏ
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Đang cập nhật sản phẩm...</p>
            }
        </div>
    </section>

    <!-- History Section -->
    <section id="history" class="history-card fade-in-up delay-3">
        <div class="history-header">
            <h2 class="history-title"><i class="bi bi-clock-history"></i> Lịch Sử Giao Dịch Gần Đây</h2>
            <button class="btn btn-secondary" onclick="window.location.href='@Url.Action("Index", "History")'">Xem tất cả</button>
        </div>

        <div class="history-list">
            @if (Model.RecentTransactions != null && Model.RecentTransactions.Any())
            {
                foreach (var transaction in Model.RecentTransactions)
                {
                    var isNegative = transaction.UserId == Model.User.UserId && transaction.ReceiverId != null && transaction.ReceiverId != Model.User.UserId;
                    var amountClass = isNegative ? "negative" : "positive";
                    var amountPrefix = isNegative ? "-" : "+";
                    
                    var iconClass = "bi-cash-coin";
                    if (transaction.TransactionType?.Contains("Sân") == true || transaction.Message?.Contains("Đặt sân") == true) iconClass = "bi-building";
                    else if (transaction.TransactionType?.Contains("Thức ăn") == true || transaction.Message?.Contains("Canteen") == true) iconClass = "bi-cup-hot-fill";

                    <div class="history-item">
                        <div class="history-icon"><i class="bi @iconClass"></i></div>
                        <div class="history-details">
                            <div class="history-item-title">@transaction.Message</div>
                            <div class="history-item-date">@transaction.TransactionDate.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                        <div class="history-amount @amountClass">@amountPrefix@transaction.Amount.ToString("N0")₫</div>
                        <span class="history-status success">Hoàn thành</span>
                    </div>
                }
            }
            else
            {
                <div class="history-empty" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
                    <p>Chưa có giao dịch nào gần đây</p>
                </div>
            }
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="features-section fade-in-up delay-2">
        <div class="section-header" style="text-align: center;">
            <h2 class="section-title"><i class="bi bi-gem"></i> Tại Sao Chọn SportHub?</h2>
            <p class="section-subtitle">Trải nghiệm đặt sân hiện đại với nhiều tiện ích vượt trội</p>
        </div>

        <div class="features-grid">
            <div class="feature-item">
                <div class="feature-icon"><i class="bi bi-lightning-fill"></i></div>
                <h3 class="feature-title">Đặt Sân Nhanh Chóng</h3>
                <p class="feature-desc">Chỉ 3 bước đơn giản, đặt sân trong vòng 30 giây</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="bi bi-credit-card-fill"></i></div>
                <h3 class="feature-title">Thanh Toán Linh Hoạt</h3>
                <p class="feature-desc">Ví điện tử, chuyển khoản, thẻ tín dụng - đa dạng phương thức</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="bi bi-gift-fill"></i></div>
                <h3 class="feature-title">Tích Điểm Thưởng</h3>
                <p class="feature-desc">Tích điểm mỗi lần đặt sân, đổi quà hấp dẫn</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="bi bi-cup-hot-fill"></i></div>
                <h3 class="feature-title">Canteen Tiện Lợi</h3>
                <p class="feature-desc">Đặt đồ ăn uống giao tận sân, không lo gián đoạn</p>
            </div>
        </div>
    </section>
</div>
<div class="modal fade" id="topupModal" tabindex="-1" aria-labelledby="topupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" id="topupModalLabel">
                    <i class="bi bi-plus-circle-fill text-primary me-2"></i>Nạp Tiền Vào Ví
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="topupForm">
                    <label class="form-label small text-muted mb-3">Chọn số tiền muốn nạp</label>
                    <div class="row g-2 mb-3">
                        <div class="col-4"><button type="button" class="btn btn-outline-primary w-100 py-2 btn-amount" data-amount="50000">50K</button></div>
                        <div class="col-4"><button type="button" class="btn btn-outline-primary w-100 py-2 btn-amount" data-amount="100000">100K</button></div>
                        <div class="col-4"><button type="button" class="btn btn-outline-primary w-100 py-2 btn-amount" data-amount="200000">200K</button></div>
                    </div>

                    <input type="number" class="form-control form-control-lg mb-4" id="topupAmount"
                           placeholder="Hoặc nhập số tiền khác" min="10000" style="border-radius: 12px; background: #f8f9fa;">

                    <label class="form-label small text-muted mb-2">Phương thức thanh toán</label>
                    <div class="payment-option p-3 mb-4 d-flex align-items-center border rounded-3 active" style="cursor: pointer;">
                        <input class="form-check-input me-3" type="radio" name="paymentMethod" checked>
                        <img src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.jpg" width="30" class="me-2">
                        <span class="small fw-bold">Cổng thanh toán VNPay</span>
                    </div>

                    <button type="button" class="btn btn-success w-100 py-3 fw-bold shadow-sm"
                            onclick="processTopup()" style="border-radius: 12px;">
                        <i class="bi bi-shield-check me-2"></i>Tiến hành nạp tiền
                    </button>
                </form>
            </div>
        </div>
    </div>

</div>
@* //modal chuyển khoản *@

<div class="modal fade" id="transferMoneyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-white text-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-send-fill me-2"></i>Chuyển tiền nội bộ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Số điện thoại người nhận</label>
                    <input type="text" id="trf_phone" class="form-control" placeholder="Nhập SĐT người nhận...">
                    <div id="trf_receiver_name" class="mt-1 small text-primary fw-bold" style="display:none"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Số tiền muốn chuyển</label>
                    <input type="number" id="trf_amount" class="form-control" placeholder="0">
                    <div class="mt-1 small text-muted">Số dư hiện tại: <span class="fw-bold">@Model.User.WalletBalance.ToString("N0")₫</span></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Lời nhắn</label>
                    <textarea id="trf_message" class="form-control" rows="2" placeholder="Nhập nội dung..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btn_confirm_transfer" class="btn btn-success px-4">Xác nhận chuyển</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/js/Home.js"></script>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header bg-primary text-white py-3">
                    <h5 class="modal-title fw-bold" id="purchaseModalTitle"><i class="fa-solid fa-cart-shopping me-2"></i>Thanh toán sản phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                        <img id="modalProductImage" src="" alt="" class="rounded-3 me-3" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid #fff;">
                        <div>
                            <h6 id="modalProductName" class="fw-bold mb-1" style="font-size: 1.1rem;"></h6>
                            <p id="modalProductPrice" class="text-primary fw-bold mb-0"></p>
                        </div>
                    </div>
                    
                    <div class="bg-light p-3 rounded-3 mb-4">
                        <label class="form-label fw-bold mb-2">Số lượng mua</label>
                        <div class="input-group">
                            <button class="btn btn-outline-primary px-3" onclick="updateQuantity(-1)">-</button>
                            <input type="number" id="purchaseQuantity" class="form-control text-center fw-bold border-primary" value="1" min="1" readonly>
                            <button class="btn btn-outline-primary px-3" onclick="updateQuantity(1)">+</button>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <span class="text-muted">Tổng cộng:</span>
                            <h4 id="modalTotalPrice" class="text-danger fw-bold mb-0">0₫</h4>
                        </div>
                    </div>

                    <div class="alert alert-info border-0 mb-0" style="background-color: #e3f2fd; color: #0d47a1;">
                        <i class="fa-solid fa-circle-info me-2"></i> Số dư sẽ được trừ trực tiếp vào ví sau khi nhấn thanh toán.
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light px-4 py-2 fw-semibold" data-bs-dismiss="modal" style="border-radius: 10px;">Hủy bỏ</button>
                    <button type="button" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm" onclick="confirmPayment()" style="border-radius: 10px;">Xác nhận thanh toán</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Success Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-body text-center p-5">
                    <div class="mb-4">
                        <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                            <i class="fa-solid fa-check fa-2xl"></i>
                        </div>
                        <h3 class="fw-bold text-success" id="successTitle">Thanh toán thành công!</h3>
                        <p class="text-muted" id="successMessage">Vui lòng lưu lại mã QR dưới đây và đưa cho nhân viên để nhận đồ.</p>
                    </div>
                    
                     <div class="qr-container p-3 bg-white border rounded-4 mb-4 shadow-sm">
                        <img id="purchaseQrCode" src="" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                        <div id="qrCountdown" class="mt-3 fw-bold text-danger" style="font-size: 1.1rem;">
                            Hết hạn sau: <span id="timer">15:00</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary w-100 py-3 fw-bold" onclick="location.reload()" style="border-radius: 15px;">Đã hiểu, Quay lại</button>
                </div>
            </div>
        </div>
    </div>
}
@if (TempData["PaymentMessage"] != null)
{
    <script>
        Swal.fire({
            title: '@(TempData["PaymentStatus"]?.ToString() == "success" ? "Thành công!" : "Thất bại!")',
            html: '@Html.Raw(TempData["PaymentMessage"])',
            icon: '@TempData["PaymentStatus"]',
            confirmButtonText: 'Đồng ý',
            confirmButtonColor: '#28a745'
        });
    </script>
}