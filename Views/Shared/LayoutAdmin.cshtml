<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - SportHub Admin</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/AdminLayout.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/AdminQR.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a asp-controller="Dashboard" asp-action="Index" class="logo">
                    <img src="~/asset/img/logo.png" alt="Logo" class="logo-icon" />
                    <div class="logo-text"><span class="logo-title">TQTSport</span></div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu Chính</div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a asp-controller="Dashboard" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-speedometer2"></i></span><span class="nav-text">Dashboard</span></a></li>
                        <li class="nav-item"><a asp-controller="BookingAD" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-calendar-event-fill"></i></span><span class="nav-text">Quản lý Sân</span></a></li>
                        <li class="nav-item"><a asp-controller="UserAD" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-people-fill"></i></span><span class="nav-text">Người Dùng</span></a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Dịch Vụ</div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a asp-controller="SportProduct" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-bag-fill"></i></span><span class="nav-text">Đồ Dùng Thể Thao</span></a></li>
                        <li class="nav-item"><a asp-controller="FoodAD" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-cup-hot-fill"></i></span><span class="nav-text">Đồ Ăn & Thức Uống</span></a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Tài Chính</div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a asp-controller="AdminPayment" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-cash-coin"></i></span><span class="nav-text">Giao Dịch & Thanh Toán</span></a></li>
                        <li class="nav-item"><a asp-controller="ReportAD" asp-action="Index" class="nav-link"><span class="nav-icon"><i class="bi bi-graph-up-arrow"></i></span><span class="nav-text">Báo Cáo</span></a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Hệ Thống</div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a asp-controller="Login" asp-action="Signout" class="nav-link"><span class="nav-icon"><i class="bi bi-box-arrow-right"></i></span><span class="nav-text">Đăng Xuất</span></a></li>
                    </ul>
                </div>
            </nav>
        </aside>
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">☰</button>
                    <h1>Chào mừng trở lại, Admin</h1>
                    <p class="header-subtitle">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary d-flex align-items-center gap-2 me-3" id="startScannerBtn" style="border-radius: 10px; padding: 8px 16px;">
                        <i class="bi bi-qr-code-scan"></i>
                        <span class="d-none d-md-inline">Quét QR</span>
                    </button>
                    <a asp-controller="AdminProfile" asp-action="Index" class="nav-link header-user-link"><i class="bi bi-person-circle"></i></a>
                </div>
            </header>
            <main class="content-wrapper">@RenderBody()</main>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="modal fade" id="qrScannerModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-qr-code-scan me-2"></i>Quét mã QR</h5>
                    <button type="button" class="btn-close btn-close-white" id="stopScannerBtn" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="reader"></div>
                    <div class="text-center mt-3">
                        <p class="text-muted small mb-3">Vui lòng đưa mã QR vào khung hình</p>
                        <div class="d-grid">
                            <label class="btn btn-outline-primary" style="border-radius: 10px; cursor: pointer;">
                                <i class="bi bi-image me-2"></i>Chọn ảnh từ thiết bị
                                <input type="file" id="qr-input-file" accept="image/*" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @await Html.PartialAsync("_AdminQRModals")
    <script src="~/js/AdminQRHandler.js"></script>
    <script>
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (menuToggle) menuToggle.addEventListener('click', () => { sidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); });
        if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { sidebar.classList.remove('active'); sidebarOverlay.classList.remove('active'); });

        const navLinks = document.querySelectorAll('.nav-link');
        const normalizePath = (path) => path.replace(/\/+$/, "").toLowerCase();
        const currentPath = normalizePath(window.location.pathname);
        navLinks.forEach(link => {
            const linkPath = normalizePath(new URL(link.href).pathname);
            if (linkPath === currentPath || (currentPath.startsWith(linkPath) && linkPath !== '/' && linkPath.length > 1)) {
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo AdminQR
            AdminQR.init({
                onSuccess: function(code, type) {
                    // Nếu trang hiện tại có định nghĩa applyFilters (như AdminPayment), hãy dùng nó
                    if (typeof applyFilters === 'function') applyFilters();
                    else location.reload();
                }
            });

            let html5QrCode = null;
            let isScanning = false; 

            const qrScannerModalEl = document.getElementById('qrScannerModal');
            if (!qrScannerModalEl) return;
            const qrModal = new bootstrap.Modal(qrScannerModalEl);

            
            async function stopScanner() {
                if (!html5QrCode || !isScanning) return;

                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    
                } catch (err) {
                    console.error("Stop scanner error:", err);
                    isScanning = false;
                }
            }

          
            document.getElementById('startScannerBtn')?.addEventListener('click', async function() {
                // Đảm bảo scanner cũ đã dừng trước khi mở modal mới
                await stopScanner();
                
                qrModal.show();

                setTimeout(async () => {
                    try {
                        if (!html5QrCode) {
                            html5QrCode = new Html5Qrcode("reader");
                        }
                        
                        isScanning = true;
                        await html5QrCode.start(
                            { facingMode: "environment" },
                            { fps: 10, qrbox: { width: 250, height: 250 } },
                            onScanSuccess
                        );
                    } catch (err) {
                        console.error("Start scanner error:", err);
                        isScanning = false;
                        qrModal.hide();
                        Swal.fire('Lỗi', 'Không thể khởi động camera. Vui lòng kiểm tra quyền truy cập.', 'error');
                    }
                }, 400);
            });

         
            document.getElementById('stopScannerBtn')?.addEventListener('click', async function() {
                await stopScanner();
            });

          
            qrScannerModalEl.addEventListener('hidden.bs.modal', async function() {
                await stopScanner();
            });

        
            document.getElementById('qr-input-file')?.addEventListener('change', async function(e) {
                if (e.target.files.length == 0) return;

                await stopScanner();

                const fileQrCode = new Html5Qrcode("reader");
                Swal.fire({ title: 'Đang đọc mã...', didOpen: () => Swal.showLoading() });

                try {
                    const decodedText = await fileQrCode.scanFile(e.target.files[0], true);
                    Swal.close();
                    qrModal.hide();
                    processQrCode(decodedText);
                } catch (err) {
                    Swal.close();
                    qrModal.hide(); // Đóng modal quét trước
                    setTimeout(() => {
                        Swal.fire('Thất bại', 'Không tìm thấy mã QR.', 'error');
                    }, 200);
                }
            });

  
            async function onScanSuccess(decodedText) {
                // Dừng scanner ngay lập tức
                await stopScanner();
                qrModal.hide();

                // Đợi modal đóng hoàn toàn rồi mới xử lý
                setTimeout(() => {
                    processQrCode(decodedText);
                }, 300);
            }


            function processQrCode(decodedText) {
                console.log("QR Scanned:", decodedText);

                if (decodedText.startsWith("BOOKING:")) {
                    const bookingCode = decodedText.replace("BOOKING:", "").trim();
                    AdminQR.handleBookingScan(bookingCode);
                }
                else if (decodedText.startsWith("PURCHASE:")) {
                    const parts = decodedText.split(":");
                    const orderId = parts[1];
                    const orderCode = parts[2] || orderId;

                    Swal.close(); // Đóng loading nếu có

                    Swal.fire({
                        title: 'Đã tìm thấy đơn hàng!',
                        html: `<p class="mb-0">Mã đơn: <b>${orderCode}</b></p>`,
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'Xử lý ngay',
                        cancelButtonText: 'Hủy'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            AdminQR.showFulfillmentModal(parseInt(orderId));
                        }
                    });
                }
                else {
                    Swal.close();
                    Swal.fire('Thông báo', 'Mã QR không hợp lệ hoặc không được hỗ trợ.', 'warning');
                }
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
