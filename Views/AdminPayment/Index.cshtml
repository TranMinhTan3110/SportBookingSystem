@model SportBookingSystem.DTO.PaymentDashboardDTO

@{
    ViewData["Title"] = "Quản lý Thanh Toán";
    Layout = "~/Views/Shared/LayoutAdmin.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/AdminPayment.css" />
}

<div class="payment-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h2 class="page-title">Quản lý Thanh Toán</h2>
        </div>
        <div class="header-actions">
            <button class="btn-export">
                <i class="bi bi-download"></i> Xuất báo cáo
            </button>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <!-- Revenue Card -->
        <div class="stat-card revenue-card">
            <div class="stat-icon-wrapper">
                <i class="bi bi-graph-up-arrow"></i>
            </div>
            <div class="stat-content">
                <h6 class="stat-label">Doanh thu Thực tế</h6>
                <h3 class="stat-value">@Model.Revenue.ToString("N0")đ</h3>
                <div class="stat-trend positive">
                    <i class="bi bi-arrow-up-short"></i> 
                    <span>+12.5% so với tuần trước</span>
                </div>
            </div>
        </div>

        <!-- Deposits Card -->
        <div class="stat-card deposit-card">
            <div class="stat-icon-wrapper">
                <i class="bi bi-wallet2"></i>
            </div>
            <div class="stat-content">
                <h6 class="stat-label">Tổng tiền Nạp (User)</h6>
                <h3 class="stat-value">@Model.TotalDeposits.ToString("N0")đ</h3>
                <div class="stat-trend neutral">
                    <i class="bi bi-dash"></i> 
                    <span>Ổn định</span>
                </div>
            </div>
        </div>

        <!-- Total Transactions Card -->
        <div class="stat-card pending-card">
            <div class="stat-icon-wrapper">
                <i class="bi bi-receipt"></i>
            </div>
            <div class="stat-content">
                <h6 class="stat-label">Tổng số giao dịch</h6>
                <h3 class="stat-value">@Model.TransactionCount</h3>
                <div class="stat-trend neutral">
                    <i class="bi bi-bar-chart"></i> 
                    <span>Tất cả loại giao dịch</span>
                </div>
            </div>
        </div>

        <!-- Reward Settings Card -->
        <div class="stat-card settings-card">
            <div class="stat-icon-wrapper">
                <i class="bi bi-gear-fill"></i>
            </div>
            <div class="stat-content">
                <h6 class="stat-label">Cài đặt điểm thưởng</h6>
                <p class="settings-description">Quản lý tỷ lệ quy đổi và chính sách điểm thưởng</p>
                <button class="btn-settings" data-bs-toggle="modal" data-bs-target="#rewardSettingsModal">
                    <i class="bi bi-arrow-right-circle"></i> Cấu hình
                </button>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="filter-bar">
        <div class="filter-row">
            <div class="search-wrapper">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Tìm theo Mã GD hoặc User...">
            </div>
            <select id="typeFilter" class="filter-select">
                <option value="all">Tất cả loại GD</option>
                <option value="Nạp tiền">Nạp tiền</option>
                <option value="Thanh toán">Thanh toán (Booking/Order)</option>
                <option value="Hoàn tiền">Hoàn tiền</option>
            </select>
            <select id="statusFilter" class="filter-select">
                <option value="all">Tất cả trạng thái</option>
                <option value="Completed">Thành công</option>
                <option value="Pending">Chờ xử lý</option>
                <option value="Cancelled">Đã hủy</option>
            </select>
            <input type="date" id="dateFilter" class="filter-date">
            <button id="resetFilters" class="btn-reset">
                <i class="bi bi-arrow-counterclockwise"></i> Đặt lại
            </button>
        </div>
    </div>

    <!-- Main Table -->
    <div class="table-card">
        <div class="table-wrapper">
            <table class="payment-table">
                <thead>
                    <tr>
                        <th>Mã Giao Dịch</th>
                        <th>Người dùng</th>
                        <th>Loại giao dịch</th>
                        <th class="text-right">Số tiền</th>
                        <th>Nguồn/Phương thức</th>
                        <th>Thời gian</th>
                        <th>Trạng thái</th>
                        <th class="text-right">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="paymentTableBody">
                    @foreach (var item in Model.Payments)
                    {
                        <tr class="payment-row">
                            <td class="transaction-code">@item.Code</td>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar-circle">@item.User?.Substring(0, 1).ToUpper()</div>
                                    <span class="user-name">@item.User</span>
                                </div>
                            </td>
                            <td>
                                @{ var type = (item.Type ?? "").Trim(); }
                                @if (type == "Nạp tiền" || type == "Hoàn tiền" || type == "Hoàn tiền đặt sân")
                                {
                                    <span class="badge badge-success">@item.Type</span>
                                }
                                else if (type == "Thanh toán Booking" || type == "Thanh toán Order")
                                {
                                    <span class="badge badge-secondary">@item.Type</span>
                                }
                                else if (type == "Chuyển tiền")
                                {
                                    <span class="badge badge-info">@item.Type</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">@item.Type</span>
                                }
                            </td>
                            <td class="text-right">
                                @if (type == "Hoàn tiền" || type == "Hoàn tiền đặt sân")
                                {
                                    <span class="amount-negative">-@item.Amount.ToString("N0")đ</span>
                                }
                                else
                                {
                                    <span class="amount-positive">+@item.Amount.ToString("N0")đ</span>
                                }
                            </td>
                            <td>
                                <span class="payment-source">@item.Source</span>
                            </td>
                            <td>
                                <div class="date-cell">
                                    <div class="date-main">@item.Date.ToString("dd/MM/yyyy")</div>
                                    <div class="date-time">@item.Date.ToString("HH:mm")</div>
                                </div>
                            </td>
                            <td>
                                @if (item.Status != null)
                                {
                                    var statusTrim = item.Status.Trim();

                                    @if (statusTrim == "Thành công")
                                    {
                                        <span class="status-indicator">
                                            <span class="status-dot status-success"></span>
                                            <span class="status-text status-success-text">Thành công</span>
                                        </span>
                                    }
                                    else if (statusTrim == "Chờ xử lý" || statusTrim == "Chờ xác nhận")
                                    {
                                        <span class="status-indicator">
                                            <span class="status-dot status-warning"></span>
                                            <span class="status-text status-warning-text">Chờ xác nhận</span>
                                        </span>
                                    }
                                    else if (statusTrim == "Đã hủy" || statusTrim == "Đã hủy đặt sân")
                                    {
                                        <span class="status-indicator">
                                            <span class="status-dot status-danger"></span>
                                            <span class="status-text status-danger-text">Đã hủy</span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="status-text">@item.Status</span>
                                    }
                                }
                            </td>
                            <td class="text-right">
                                <button class="btn-icon btn-view-details" title="Chi tiết" data-code="@item.Code"><i class="bi bi-eye"></i></button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-wrapper">
            <small class="pagination-info">
                Hiển thị <span id="visibleCount">@Model.Payments.Count</span> / @Model.TransactionCount bản ghi
            </small>
            <nav class="pagination-nav">
                <ul class="pagination">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a href="?page=@(Model.CurrentPage - 1)" class="page-link">Trước</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled">
                            <span class="page-link">Trước</span>
                        </li>
                    }

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        if (i == Model.CurrentPage)
                        {
                            <li class="page-item active">
                                <span class="page-link">@i</span>
                            </li>
                        }
                        else if (i == 1 || i == Model.TotalPages || (i >= Model.CurrentPage - 2 && i <= Model.CurrentPage + 2))
                        {
                            <li class="page-item">
                                <a href="?page=@i" class="page-link">@i</a>
                            </li>
                        }
                        else if (i == Model.CurrentPage - 3 || i == Model.CurrentPage + 3)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a href="?page=@(Model.CurrentPage + 1)" class="page-link">Sau</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled">
                            <span class="page-link">Sau</span>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    </div>

    <!-- Transaction Management Section -->
    <div class="transaction-management-section">
        <div class="section-header">
            <h3 class="section-title">Quản lý Giao dịch</h3>
            <p class="section-subtitle">Nhập tay giao dịch nạp tiền hoặc tạo đơn hàng</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="deposit">
                <i class="bi bi-cash-coin"></i> Nạp tiền
            </button>
            <button class="tab-btn" data-tab="purchase">
                <i class="bi bi-cart-plus"></i> Mua sản phẩm
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content-wrapper">
            <!-- Deposit Tab -->
            <div class="tab-content active" id="deposit-tab">
                <form id="depositForm" class="transaction-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="depositUser">Số điện thoại khách hàng <span class="required">*</span></label>
                            <input type="text" id="depositUser" class="form-input" placeholder="Nhập số điện thoại khách hàng" required>
                            <small class="form-hint">Số dư hiện tại: <span id="depositUserBalance">0đ</span></small>
                        </div>

                        <div class="form-group">
                            <label for="depositAmount">Số tiền nạp <span class="required">*</span></label>
                            <input type="number" id="depositAmount" class="form-input" placeholder="Nhập số tiền" min="1000" step="1000" required>
                        </div>

                        <div class="form-group">
                            <label for="depositMethod">Phương thức thanh toán <span class="required">*</span></label>
                            <select id="depositMethod" class="form-input" required>
                                <option value="">-- Chọn phương thức --</option>
                                <option value="Cash">Tiền mặt</option>
                                <option value="Banking">Chuyển khoản</option>
                                <option value="Momo">Momo</option>
                                <option value="VNPAY">VNPAY</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="depositMessage">Ghi chú</label>
                            <textarea id="depositMessage" class="form-input" rows="3" placeholder="Nhập ghi chú (không bắt buộc)"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit button-create">
                            <i class="bi bi-check-circle"></i> Tạo giao dịch nạp tiền
                        </button>
                        <button type="reset" class="btn-reset-form">
                            <i class="bi bi-x-circle"></i> Đặt lại
                        </button>
                    </div>
                </form>
            </div>

            <!-- Purchase Tab -->
            <div class="tab-content" id="purchase-tab">
                <form id="purchaseForm" class="transaction-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="purchaseUser">Số điện thoại khách hàng <span class="required">*</span></label>
                            <input type="text" id="purchaseUser" class="form-input" placeholder="Nhập số điện thoại khách hàng" required>
                            <small class="form-hint">Số dư hiện tại: <span id="purchaseUserBalance">0đ</span></small>
                        </div>

                        <div class="form-group">
                            <label for="purchaseProduct">Chọn sản phẩm <span class="required">*</span></label>
                            <select id="purchaseProduct" class="form-input" required>
                                <option value="">-- Chọn sản phẩm --</option>
                            </select>
                            <small class="form-hint">Tồn kho: <span id="productStock">0</span></small>
                        </div>

                        <div class="form-group">
                            <label for="purchaseQuantity">Số lượng <span class="required">*</span></label>
                            <input type="number" id="purchaseQuantity" class="form-input" placeholder="Nhập số lượng" min="1" value="1" required>
                        </div>

                        <div class="form-group">
                            <label for="purchasePrice">Đơn giá</label>
                            <input type="text" id="purchasePrice" class="form-input" readonly>
                        </div>

                        <div class="form-group">
                            <label for="purchaseTotal">Tổng tiền</label>
                            <input type="text" id="purchaseTotal" class="form-input total-amount" readonly>
                        </div>

                        <div class="form-group">
                            <label for="purchaseMethod">Phương thức thanh toán <span class="required">*</span></label>
                            <select id="purchaseMethod" class="form-input" required>
                                <option value="">-- Chọn phương thức --</option>
                                <option value="Cash">Tiền mặt</option>
                                <option value="Banking">Chuyển khoản</option>
                                <option value="Wallet">Ví nội bộ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">
                            <i class="bi bi-check-circle"></i> Tạo đơn hàng
                        </button>
                        <button type="reset" class="btn-reset-form">
                            <i class="bi bi-x-circle"></i> Đặt lại
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@* modal xét điểm thưởng *@
<div class="modal fade" id="rewardSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-gear-fill me-2 text-primary"></i>Cài đặt điểm thưởng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rewardSettingsForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold">Tỷ lệ quy đổi điểm (Tiêu dùng)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-secondary text-white border-0">10,000đ =</span>
                            <input type="number" id="spendingRatio" class="form-control bg-dark text-white border-secondary" value="1" min="1">
                            <span class="input-group-text bg-secondary text-white border-0">Điểm</span>
                        </div>
                        <small class="text-muted">Khách đặt sân hoặc mua đồ sẽ nhận được số điểm này.</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Tỷ lệ quy đổi điểm (Nạp tiền)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-secondary text-white border-0">100,000đ =</span>
                            <input type="number" id="depositRatio" class="form-control bg-dark text-white border-secondary" value="0" min="0">
                            <span class="input-group-text bg-secondary text-white border-0">Điểm</span>
                        </div>
                        <small class="text-muted">Để 0 nếu không muốn tặng điểm khi khách nạp tiền.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Trạng thái hệ thống tích điểm</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isRewardActive" checked>
                            <label class="form-check-label" for="isRewardActive">Đang hoạt động</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="saveRewardSettings" class="btn btn-primary">Lưu cấu hình</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal Chi tiết giao dịch -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    Chi tiết giao dịch
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="detailsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Đang tải chi tiết...</p>
                </div>
                <div id="detailsContent" class="d-none">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-secondary bg-opacity-10 rounded-3 h-100">
                                <label class="text-muted small d-block mb-1">Mã giao dịch</label>
                                <div id="detCode" class="fw-bold text-primary fs-5">-</div>
                                <hr class="my-2 border-secondary opacity-25">
                                <label class="text-muted small d-block mb-1">Thời gian</label>
                                <div id="detDate" class="fw-semibold">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-secondary bg-opacity-10 rounded-3 h-100">
                                <label class="text-muted small d-block mb-1">Trạng thái</label>
                                <div id="detStatusBadge">-</div>
                                <hr class="my-2 border-secondary opacity-25">
                                <label class="text-muted small d-block mb-1">Loại & Nguồn</label>
                                <div><span id="detType" class="fw-semibold">-</span> | <span id="detSource" class="text-muted small">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="text-muted small d-block mb-2">Thông tin khách hàng</label>
                            <div class="d-flex align-items-center">
                                <div id="detAvatar" class="avatar-circle me-3">U</div>
                                <div>
                                    <div id="detUser" class="fw-bold fs-6">-</div>
                                    <div id="detPhone" class="text-muted small">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <label class="text-muted small d-block mb-1">Số tiền giao dịch</label>
                            <div id="detAmount" class="fs-3 fw-bold text-success">-</div>
                            <div class="text-muted small">Số dư sau GD: <span id="detBalanceAfter">-</span></div>
                        </div>
                    </div>

                    <div id="detOrderSection" class="d-none mt-4">
                        <label class="text-muted small d-block mb-2">Chi tiết sản phẩm</label>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover border-secondary">
                                <thead class="table-secondary text-dark">
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end">Đơn giá</th>
                                        <th class="text-end">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody id="detItemsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="detBookingSection" class="d-none mt-4">
                        <div class="p-3 border border-primary border-opacity-25 rounded-3 bg-primary bg-opacity-10">
                            <label class="text-primary small d-block mb-2 fw-bold">Thông tin thuê sân</label>
                            <div class="row">
                                <div class="col-sm-6 mb-3 mb-sm-0">
                                    <div class="text-muted small">Sân</div>
                                    <div id="detPitchName" class="fw-bold">-</div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="text-muted small">Thời gian</div>
                                    <div id="detBookingTime" class="fw-bold">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="detMessageSection" class="d-none mt-4">
                        <label class="text-muted small d-block mb-1">Ghi chú</label>
                        <div id="detMessage" class="p-3 bg-secondary bg-opacity-10 rounded-3 font-italic">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/AdminPayment.js"></script>

}

